<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#0FA36B"/>

<title>
  Wonder-Server: Public API gateway powering pickups, feeds, and growth | Zinus Tech Blog
</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Wonder-Server: Public API gateway powering pickups, feeds, and growth | Zinus Tech Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Wonder-Server: Public API gateway powering pickups, feeds, and growth" />
<meta name="author" content="Zinus Engineering" />
<meta property="og:locale" content="en" />
<meta name="description" content="Zinus Wonder-Server (WAPI) is our public-facing API layer that brokers trusted access between external systems and our Shopify stores. It centralizes cross-cutting concerns like HTTPS enforcement, CORS, rate limiting, authentication/authorization, and integrates with external providers for email, growth, and compliance workflows." />
<meta property="og:description" content="Zinus Wonder-Server (WAPI) is our public-facing API layer that brokers trusted access between external systems and our Shopify stores. It centralizes cross-cutting concerns like HTTPS enforcement, CORS, rate limiting, authentication/authorization, and integrates with external providers for email, growth, and compliance workflows." />
<link rel="canonical" href="http://localhost:4000/Zinus/posts/2025/09/10/wonder-server-architecture-and-apis/" />
<meta property="og:url" content="http://localhost:4000/Zinus/posts/2025/09/10/wonder-server-architecture-and-apis/" />
<meta property="og:site_name" content="Zinus Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-09-10T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Wonder-Server: Public API gateway powering pickups, feeds, and growth" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zinus Engineering"},"dateModified":"2025-09-10T00:00:00+09:00","datePublished":"2025-09-10T00:00:00+09:00","description":"Zinus Wonder-Server (WAPI) is our public-facing API layer that brokers trusted access between external systems and our Shopify stores. It centralizes cross-cutting concerns like HTTPS enforcement, CORS, rate limiting, authentication/authorization, and integrates with external providers for email, growth, and compliance workflows.","headline":"Wonder-Server: Public API gateway powering pickups, feeds, and growth","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Zinus/posts/2025/09/10/wonder-server-architecture-and-apis/"},"url":"http://localhost:4000/Zinus/posts/2025/09/10/wonder-server-architecture-and-apis/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="icon" href="/Zinus/assets/favicon.svg" type="image/svg+xml">

<link rel="stylesheet" href="/Zinus/assets/css/main.css">

<!-- Mermaid for diagrams in posts -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    flowchart: { htmlLabels: false }
  });
</script>



  </head>
  <body class="site">
    <a class="skip-link" href="#content">Skip to content</a>
    <header class="site-header">
  <div class="container header__inner">
    <a class="brand" href="/Zinus/" aria-label="Zinus Tech Blog">
      <span class="brand__mark">Z</span>
      <span class="brand__name">Zinus Engineering</span>
    </a>
    <button class="nav-toggle" aria-expanded="false" aria-controls="site-nav">Menu</button>
    <nav id="site-nav" class="nav" aria-label="Primary navigation">
      <ul>
        
          <li><a href="http://localhost:4000/Zinus/">Home</a></li>
        
          <li><a href="http://localhost:4000/Zinus/posts/">Posts</a></li>
        
          <li><a href="http://localhost:4000/Zinus/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</header>
<script src="/Zinus/assets/js/site.js" defer></script>



    <main id="content" class="container">
      <article class="post">
  <header class="post__header">
    <h1 class="post__title">Wonder-Server: Public API gateway powering pickups, feeds, and growth</h1>
    <div class="post__meta">
      <time datetime="2025-09-10T00:00:00+09:00">2025.09.10</time>
      
        · <span>Zinus Engineering</span>
      
    </div>
    
      <div class="post__authors">
        
          <a class="author" href="https://www.linkedin.com/in/gabenunez/" target="_blank" rel="noopener">
            
            <img class="author__avatar" src="/Zinus/assets/img/avatar-fallback.svg" alt="Gabe (Gabriel) Nuñez">
            <span class="author__meta">
              <span class="author__name">Gabe (Gabriel) Nuñez</span>
              <span class="author__role">Lead Developer (2019–2021)</span>
            </span>
          </a>
        
          <a class="author" href="https://github.com/yongwansong" target="_blank" rel="noopener">
            
            <img class="author__avatar" src="/Zinus/assets/img/avatar-fallback.svg" alt="Yong Wan Song">
            <span class="author__meta">
              <span class="author__name">Yong Wan Song</span>
              <span class="author__role">Software Engineer (2021–present)</span>
            </span>
          </a>
        
          <a class="author" href="https://github.com/DCarrollUSMC" target="_blank" rel="noopener">
            
            <img class="author__avatar" src="/Zinus/assets/img/avatar-fallback.svg" alt="Daniel Carroll">
            <span class="author__meta">
              <span class="author__name">Daniel Carroll</span>
              <span class="author__role">Software Engineer (2021–present)</span>
            </span>
          </a>
        
          <a class="author" href="https://www.linkedin.com/in/junkukkim/" target="_blank" rel="noopener">
            
            <img class="author__avatar" src="/Zinus/assets/img/avatar-fallback.svg" alt="Junkuk (Mason) Kim">
            <span class="author__meta">
              <span class="author__name">Junkuk (Mason) Kim</span>
              <span class="author__role">DevOps Engineer, Zinus</span>
            </span>
          </a>
        
      </div>
    
  </header>
  <div class="post__content">
    <p>Zinus Wonder-Server (WAPI) is our public-facing API layer that brokers trusted access between external systems and our Shopify stores. It centralizes cross-cutting concerns like HTTPS enforcement, CORS, rate limiting, authentication/authorization, and integrates with external providers for email, growth, and compliance workflows.</p>

<h3 id="highlights">Highlights</h3>
<ul>
  <li>Enforces HTTPS, CORS allowlist per domain, and rate limiting in production</li>
  <li>JWT-protected private routes with scope-based authorization</li>
  <li>Shopify Admin GraphQL integration for order reads/writes</li>
  <li>LoadUp GraphQL integration for California mattress/box-spring pickups</li>
  <li>Growth utilities: Klaviyo subscription and back-in-stock proxy</li>
  <li>Operational utilities: product feed, eBay integration, email relay</li>
</ul>

<h3 id="history--ownership">History &amp; ownership</h3>
<ul>
  <li>Oct 2019 → Oct 2021: Initial build and maintenance by Gabe (Gabriel) Nuñez.</li>
  <li>Since Oct 2021: Maintenance and enhancements by Yong Wan Song and Daniel Carroll.</li>
  <li>DevOps: Junkuk (Mason) Kim manages infrastructure and operations.</li>
</ul>

<h3 id="architecture">Architecture</h3>

<div class="mermaid">
flowchart LR
  A[Storefront/Shogun] --&gt; B[Ingress HTTP]
  C[Shopify Webhooks] --&gt; B
  D[Ops tools] --&gt; B

  B --&gt; E[CORS allowlist]
  E --&gt; F[Rate limit 15m 300IP]
  F --&gt; G[Public routes]
  F --&gt; H[Private routes]
  H --&gt; I[express-jwt]
  I --&gt; J[checkScopeAccess]

  G --&gt; G1[GET /api/product-feed]
  G --&gt; G2[POST /api/klaviyo/back-in-stock]
  G --&gt; G3[POST /api/klaviyo/subscribe]
  G --&gt; G4[POST /api/cj-track]
  G --&gt; G5[POST /api/rebuy-proxy]
  G --&gt; G6[POST /api/email]
  G --&gt; G7[GET /]
  G --&gt; G8[GET /api/ebay]

  J --&gt; H1[POST /api/pickup/schedule]
  J --&gt; H2[POST /api/pickup/cancel]
  J --&gt; H3[POST /api/pickup/refund]

  H1 --&gt; L[LoadUp GraphQL]
  H2 --&gt; L
  H3 --&gt; L
  H1 --&gt; S[Shopify Admin GraphQL]
  H3 --&gt; S
  G1 --&gt; S
  G2 --&gt; K[Klaviyo API]
  G3 --&gt; K
  G4 --&gt; CJ[CJ Affiliate]
  G5 --&gt; R[Rebuy API]
  G6 --&gt; M[Nodemailer]
  G8 --&gt; EBY[eBay API]
</div>

<h3 id="pickup-flow-sequence">Pickup flow (sequence)</h3>

<div class="mermaid">
sequenceDiagram
  participant SF as Storefront/Shogun
  participant WAPI as Wonder-Server
  participant LoadUp as LoadUp GraphQL
  participant Shopify as Shopify Admin GraphQL

  SF-&gt;&gt;WAPI: POST /api/pickup/schedule (order payload)
  WAPI-&gt;&gt;WAPI: Count mattress/box-spring items
  alt Pickup required (CA + attribute)
    WAPI-&gt;&gt;LoadUp: createPricedScheduleRequest (1..n)
    LoadUp--&gt;&gt;WAPI: scheduleRequest IDs
    WAPI-&gt;&gt;Shopify: orderUpdate(customAttributes += LoadUp IDs)
    Shopify--&gt;&gt;WAPI: OK
    WAPI--&gt;&gt;SF: 201 Created (Pickup request generated)
  else Not required
    WAPI--&gt;&gt;SF: 202 Accepted (No pickup required)
  end
</div>

<h3 id="request-pipeline-production">Request pipeline (production)</h3>
<p>1) Trust proxy and force HTTPS
2) Global rate limiting (15m window, 300 req/IP)
3) CORS validation against allowlist (<code class="language-plaintext highlighter-rouge">*.zinus.*</code>, Shogun, Mellow, etc.)
4) JWT validation for private routes, then scope-check middleware</p>

<pre><code class="language-12:33:c:/Zinus/Zinus/Wonder-Server/server.js">if (isProduction) {
  app.enable('trust proxy');
  app.use(function (req, res, next) {
    if (req.secure) { return next(); } else { return res.redirect('https://' + req.headers.host + req.url); }
  });
  const limiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 300 });
  app.use(limiter);
}
</code></pre>

<h3 id="security-model">Security model</h3>
<ul>
  <li>Public endpoints: health, product feed, some growth endpoints</li>
  <li>Private endpoints: protected by <code class="language-plaintext highlighter-rouge">express-jwt</code> and <code class="language-plaintext highlighter-rouge">checkScopeAccess([...])</code></li>
</ul>

<pre><code class="language-1:20:c:/Zinus/Zinus/Wonder-Server/middleware/auth.js">exports.checkScopeAccess = (requiredScopes) =&gt; {
  return (req, res, next) =&gt; {
    if (isProduction) {
      const token = req.user;
      token.scopes.forEach((scope) =&gt; {
        if (requiredScopes.find((requiredScope) =&gt; requiredScope === scope)) {
          return next();
        } else {
          return res.status(401).json({ code: '401', error: 'Insufficient permissions' });
        }
      });
    } else { return next(); }
  };
};
</code></pre>

<h3 id="key-capabilities">Key capabilities</h3>

<h4 id="1-california-pickup-orchestration-loadup--shopify">1) California pickup orchestration (LoadUp + Shopify)</h4>
<ul>
  <li>Robust item classifier detects mattresses, box springs, and paired combos, transforming Shopify webhooks into actionable pickup requests.
    <pre><code class="language-12:69:c:/Zinus/Zinus/Wonder-Server/routes/pickup.js">const countPickupItems = (lineItems, quantityKey) =&gt; {
let mattressCount = 0; let boxSpringCount = 0; let mattressBoxCombo = 0;
lineItems.forEach((item) =&gt; {
  const titleIncludes = (text) =&gt; item.title.toLowerCase().includes(text);
  if (titleIncludes('box spring')) { boxSpringCount += item[quantityKey]; }
  else if (titleIncludes('mattress') &amp;&amp; !titleIncludes('topper') &amp;&amp; !titleIncludes('cover') &amp;&amp; !titleIncludes('pad')) {
    mattressCount += item[quantityKey];
  }
});
if (mattressCount &amp;&amp; boxSpringCount) { /* normalize into combos when counts align */ }
return { mattresses: mattressCount, boxSprings: boxSpringCount, comboCount: mattressBoxCombo, totalCount: mattressCount + boxSpringCount + mattressBoxCombo };
};
</code></pre>
  </li>
  <li>Schedule flow: gate by state and order attribute; persist LoadUp IDs back to Shopify for traceability/idempotency.
    <pre><code class="language-71:106:c:/Zinus/Zinus/Wonder-Server/routes/pickup.js">router.post('/schedule', async (req, res) =&gt; {
const { note_attributes, shipping_address, line_items, email, id } = req.body;
const pickupAttribute = note_attributes.find((a) =&gt; a.name === 'Pickup Requested');
const pickupRequired = pickupAttribute &amp;&amp; pickupAttribute.value.toLowerCase() === 'true';
if ((shipping_address.province === 'California' || shipping_address.province_code === 'CA') &amp;&amp; pickupRequired) {
  const pickupItemCount = countPickupItems(line_items, 'quantity');
  const pickupIDs = await generatePickupRequests({ /* address &amp; counts */ });
  await addPickupAttrToOrder({ orderID: id, pickupIDs: pickupIDs.join(',') });
  return res.status(201).json({ code: '201', response: 'Pickup request generated.' });
} else { return res.status(202).json({ code: '202', response: 'No pickup required.' }); }
});
</code></pre>
  </li>
  <li>Refund flow: cancel existing pickups and reschedule with the net quantities.
    <pre><code class="language-180:247:c:/Zinus/Zinus/Wonder-Server/routes/pickup.js">router.post('/refund', async (req, res) =&gt; {
const { refund_line_items: refundedLineItems, order_id: orderID } = req.body;
if (refundedLineItems.length) {
  const shopifyOrder = await getShopifyOrderInfo(orderID);
  /* derive counts, cancelLoadup, regenerate, update order attr */
  return res.status(201).json({ code: '201', response: 'Cancelled pickup and made new one.' });
} else {
  return res.status(202).json({ code: '202', response: 'No item refunded.' });
}
});
</code></pre>
  </li>
  <li>LoadUp + Shopify GraphQL clients and mutations.
    <pre><code class="language-7:15:c:/Zinus/Zinus/Wonder-Server/routes/components/pickup/gql.js">exports.loadupGQLclient = (() =&gt; {
const gqlURL = isProduction ? this.loadupProdURL : this.loadupDevURL;
return new GraphQLClient(gqlURL, { headers: { 'X-Access-Token': process.env.LOADUP_ACCESS_TOKEN } });
})();
</code></pre>
    <pre><code class="language-17:36:c:/Zinus/Zinus/Wonder-Server/routes/components/pickup/gql.js">exports.createPickupRequest = gql`mutation createPricedScheduleRequest($inputs: CreatePricedScheduleRequestInputs!){ createPricedScheduleRequest(inputs:$inputs){ scheduleRequest{ id total } errorCode } }`;
exports.cancelPickupRequest = gql`mutation cancelScheduleRequest($inputs: CancelScheduleRequestInputs!){ cancelScheduleRequest(inputs:$inputs){ errorCode } }`;
</code></pre>
    <pre><code class="language-7:15:c:/Zinus/Zinus/Wonder-Server/routes/components/shopify/gql.js">exports.shopifyGQLclient = (() =&gt; { /* Admin GraphQL with X-Shopify-Access-Token */ })();
</code></pre>
    <pre><code class="language-17:29:c:/Zinus/Zinus/Wonder-Server/routes/components/shopify/gql.js">exports.mutateOrder = gql`mutation orderUpdate($input: OrderInput!){ orderUpdate(input:$input){ order{ id } userErrors{ field message } } }`;
</code></pre>
    <pre><code class="language-31:62:c:/Zinus/Zinus/Wonder-Server/routes/components/shopify/gql.js">exports.orderDetails = gql`query order($id: ID!){ order(id:$id){ name customAttributes{ key value } email fulfillable shippingAddress{ firstName lastName phone address1 address2 city province provinceCode zip } lineItems(first:50){ edges{ node{ title fulfillableQuantity } } } } }`;
</code></pre>
  </li>
</ul>

<h4 id="2-growth-and-personalization">2) Growth and personalization</h4>
<ul>
  <li>Klaviyo back-in-stock: transparent proxy to the Onsite component API.
    <pre><code class="language-5:12:c:/Zinus/Zinus/Wonder-Server/routes/klaviyo.js">router.post('/back-in-stock', async (req, res) =&gt; {
const response = await axios.post('https://a.klaviyo.com/onsite/components/back-in-stock/subscribe', req.body.data ? req.body.data : new URLSearchParams(req.body).toString());
return res.json(response.data);
});
</code></pre>
  </li>
  <li>Klaviyo marketing consent (bulk create job) with region-aware API key selection (EU vs US) inferred from Origin/Referrer.
    <pre><code class="language-27:56:c:/Zinus/Zinus/Wonder-Server/routes/klaviyo.js">const getKlaviyoKey = () =&gt; { /* parse Origin/Referrer; map domain to KLAVIYO_EU_KEY or KLAVIYO_KEY */ };
</code></pre>
    <pre><code class="language-58:86:c:/Zinus/Zinus/Wonder-Server/routes/klaviyo.js">const headers = { accept:'application/json', revision:'2024-02-15', 'content-type':'application/json', Authorization:`Klaviyo-API-Key ${getKlaviyoKey()}` };
const data = { data: { type:'profile-subscription-bulk-create-job', attributes:{ custom_source:'Web Signup', profiles:{ data:[{ type:'profile', attributes:{ email, subscriptions:{ email:{ marketing:{ consent:'SUBSCRIBED' } } } } }] } }, relationships:{ list:{ data:{ type:'list', id:listId } } } } };
</code></pre>
  </li>
  <li>Rebuy personalization proxy: server-side fetch with API key and passthrough, enabling storefront widgets without exposing secrets.
    <pre><code class="language-5:12:c:/Zinus/Zinus/Wonder-Server/routes/rebuy-prox.js">router.get('/', async (req, res) =&gt; { const { data_id, product_ids, variant_ids } = req.query; const key = process.env.REBUY_API_KEY; const url = `https://rebuyengine.com/api/v1/custom/id/${data_id}?key=${key}&amp;shopify_product_ids=${product_ids}&amp;shopify_variant_ids=${variant_ids}&amp;metafields=yes`; const response = await axios.get(url); return res.json(response.data); });
</code></pre>
  </li>
  <li>CJ Affiliate tracking: 13‑month cookie on the apex domain for cross-subdomain attribution.
    <pre><code class="language-14:21:c:/Zinus/Zinus/Wonder-Server/routes/cj-track.js">res.cookie('cje', cjeventID, { domain: isProduction &amp;&amp; '.zinus.com', maxAge: thirteenMonths, httpOnly: false, secure: isProduction ? true : false });
</code></pre>
  </li>
</ul>

<h4 id="3-product-feed-generator-shopify-admin-rest">3) Product feed generator (Shopify Admin REST)</h4>
<ul>
  <li>Paginates via Link headers, filters non-sellable product types, and materializes variant-level rows with canonical image selection.
    <pre><code class="language-16:56:c:/Zinus/Zinus/Wonder-Server/routes/product-feed.js">for (product of response.data.products) {
const { body_html, title: productTitle, handle, images, variants, product_type, id: productId } = product;
if (product_type === 'Protection Plan' || product_type === 'Insurance') { continue; }
if (variants.length &gt; 1) {
  variants.forEach((variant) =&gt; {
    let variantImageId = variant.image_id; let variantImage = null;
    if (variantImageId) { const variantImageObj = images.find((image) =&gt; image.id === variantImageId); variantImage = variantImageObj?.src; }
    else if (!variantImageId &amp;&amp; images.length &gt; 0) { variantImage = images[0]?.src; }
    productFeed.push({ title: productId !== 7269091967039 ? `${productTitle} - ${variant.title}` : `${variant.title}`, id: variant.id, inventory_quantity: variant.inventory_quantity, description: convert(body_html), price: parseFloat(variant.price), link: `https://www.zinus.com/${product_type}/${handle}?variant=${variant.id}`, inventory_policy: 1, categories: [product_type], image_link: variantImage });
  });
} else {
  productFeed.push({ title: productTitle, id: variants[0].id, description: convert(body_html), inventory_quantity: variants[0].inventory_quantity, price: parseFloat(variants[0].price), link: `https://www.zinus.com/${product_type}/${handle}`, inventory_policy: 1, categories: [product_type], image_link: (images.length &gt; 0 &amp;&amp; images[0].src) || null });
}
}
</code></pre>
  </li>
</ul>

<h4 id="4-secure-email-relay-with-hcaptcha--locale-routing">4) Secure email relay with hCaptcha + locale routing</h4>
<ul>
  <li>Validates <code class="language-plaintext highlighter-rouge">hcaptcha</code> token, routes to country-specific support inboxes, handles attachments via Multer, and sets Reply-To to the customer email.
    <pre><code class="language-18:25:c:/Zinus/Zinus/Wonder-Server/routes/email.js">await axios.post('https://hcaptcha.com/siteverify', { secret: process.env.HCAPTCHA_SECRET, response: captchaToken });
</code></pre>
    <pre><code class="language-27:62:c:/Zinus/Zinus/Wonder-Server/routes/email.js">const originStoreUrl = req.header('Origin').split('www.')[1];
switch (originStoreUrl) { case 'zinus.jp': toEmail = 'customerservice-jp@zinus.com'; break; case 'zinus.com.au': toEmail = 'australianorders@zinus.com'; break; case 'zinus.fr': case 'zinus.com.de': case 'zinus.co.uk': toEmail = 'eusupport@zinus.com'; break; }
</code></pre>
    <pre><code class="language-68:79:c:/Zinus/Zinus/Wonder-Server/routes/email.js">const attachments = req.files &amp;&amp; req.files.file &amp;&amp; req.files.file.length &amp;&amp; req.files.file.map((item) =&gt; ({ filename: item.originalname, content: item.buffer }));
</code></pre>
    <pre><code class="language-86:93:c:/Zinus/Zinus/Wonder-Server/routes/email.js">await sendHTMLEmail({ toEmail, replyToEmail: customerEmail, emailSubject: `${emailSubject} - ${originStoreUrl}`, html: bodyLines.join('&lt;br /&gt;'), attachments });
</code></pre>
    <pre><code class="language-4:11:c:/Zinus/Zinus/Wonder-Server/utils/email/index.js">const transporter = nodemailer.createTransport({ host: 'smtp.gmail.com', port: 465, auth: { user: 'web-notifications@zinusinc.com', pass: process.env.GMAIL_PASSWORD } });
</code></pre>
    <pre><code class="language-22:31:c:/Zinus/Zinus/Wonder-Server/utils/email/index.js">exports.sendHTMLEmail = async (options) =&gt; { const info = await transporter.sendMail({ from: '"Zinus Robot 🤖" &lt;noreply@zinusinc.com&gt;', replyTo: options.replyToEmail, to: options.toEmail, subject: options.emailSubject, html: options.attachACat ? options.html + (await this.getCatImage()) : options.html, attachments: options.attachments || [] }); return info.messageId; };
</code></pre>
  </li>
</ul>

<h4 id="5-security-and-resilience-middleware-production">5) Security and resilience middleware (production)</h4>
<ul>
  <li>Request timeout, HTTPS redirect, CORS allowlist, rate limiting, JWT validation, and scoped authorization.
    <pre><code class="language-34:41:c:/Zinus/Zinus/Wonder-Server/server.js">app.use(timeout('20s'));
app.use(express.json());
const upload = multer();
app.get('/', (req, res) =&gt; { return res.status(200).send(welcomeMessage); });
</code></pre>
    <pre><code class="language-42:83:c:/Zinus/Zinus/Wonder-Server/server.js">const whitelist = [ 'https://www.zinus.com', /* ...regional domains... */ 'https://mellow-home.com.au' ];
const corsOptions = { origin: function (origin, callback) { if (whitelist.indexOf(origin) !== -1 || !origin) { callback(null, true); } else { callback(new Error('Not allowed by CORS')); } } };
</code></pre>
    <pre><code class="language-96:99:c:/Zinus/Zinus/Wonder-Server/server.js">const cpUpload = upload.fields([{ name: 'file', maxCount: 5 }]);
app.use('/api/email', [cors(isProduction &amp;&amp; corsOptions), cpUpload], require('./routes/email'));
</code></pre>
    <pre><code class="language-104:121:c:/Zinus/Zinus/Wonder-Server/server.js">app.use(jwt({ secret: process.env.JWT_SECRET, algorithms: ['HS256'], credentialsRequired: true, getToken: function fromHeaderOrQuerystring(req){ if (req.headers.authorization &amp;&amp; req.headers.authorization.split(' ')[0] === 'Bearer') { return req.headers.authorization.split(' ')[1]; } if (req.query &amp;&amp; req.query.token) { return req.query.token; } return null; } }));
</code></pre>
    <pre><code class="language-122:128:c:/Zinus/Zinus/Wonder-Server/server.js">app.use((err, req, res, next) =&gt; { if (err.name === 'UnauthorizedError') { return res.status(401).json({ code: '401', error: err.message }); } });
</code></pre>
    <pre><code class="language-132:135:c:/Zinus/Zinus/Wonder-Server/server.js">app.use((req, res) =&gt; { return res.status(404).json({ code: '404', error: 'Whoops, that path does not exist :o' }); });
</code></pre>
  </li>
</ul>

<h3 id="operational-learnings">Operational learnings</h3>
<ul>
  <li>Keep allowlists current across markets and staging domains</li>
  <li>Use JWT scopes for least-privilege integrations</li>
  <li>Persist third-party IDs back to Shopify for observability and idempotency</li>
  <li>Cap rate limits above storefront AJAX bursts but below abuse thresholds</li>
</ul>

<p>If you’d like a deeper dive into any module, ping the team in Slack.</p>


  </div>
  <footer class="post__footer">
    
      <div class="post__tags">
        <strong>Tags:</strong>
        <span class="tag">#shopify</span><span class="tag">#api</span><span class="tag">#nodejs</span><span class="tag">#graphql</span><span class="tag">#infrastructure</span><span class="tag">#integrations</span>
      </div>
    
    <nav class="post__pager">
      <a class="pager__prev" href="/Zinus/posts/2025/09/10/embedded-app-architecture-checkout-extensions/">← Zinus Embedded App: Remix + Shopify Functions powering checkout experiences</a>
      
    </nav>
  </footer>
</article>



    </main>
    <footer class="site-footer">
  <div class="container footer__inner">
    <p>© 2025 Zinus, Inc. All rights reserved.</p>
    <ul class="social">
      
        <li><a href="https://github.com/zinus-inc" target="_blank" rel="noopener">GitHub</a></li>
      
      
        <li><a href="https://www.linkedin.com/company/zinus-inc/posts/?feedView=all" target="_blank" rel="noopener">LinkedIn</a></li>
      
      <li><a href="/Zinus/feed.xml">RSS</a></li>
    </ul>
  </div>
</footer>



  </body>
  </html>


